name: Build and Push Container Images

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to build (api-node or client-react)'
        required: true
        type: choice
        options:
          - api-node
          - client-react
      version:
        description: 'Version tag'
        required: false
        type: string
  push:
    branches:
      - dev
    paths: ['App/**']
    tags: ['**@[0-9]*.[0-9]*.[0-9]*']

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    outputs:
      services: ${{ steps.set.outputs.services }}
      environment: ${{ steps.set.outputs.environment }}
      version: ${{ steps.set.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
    
      - name: Detect changes
        id: changes
        if: github.event_name == 'push' && github.ref_type == 'branch'
        uses: dorny/paths-filter@v3
        with:
          filters: .github/utils/file-filters.yaml

      - name: Determine build configuration
        id: set
        run: |
          # Manual run
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "services=[\"${{ inputs.service }}\"]" >> $GITHUB_OUTPUT
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          
          # Tag push (production)
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            SERVICE="${GITHUB_REF_NAME%%@*}"
            VERSION="${GITHUB_REF_NAME##*@}"
            echo "services=[\"$SERVICE\"]" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "version=v${VERSION}" >> $GITHUB_OUTPUT
          
          # Push to main (staging)
          else
            echo "services=${{ steps.changes.outputs.changes }}" >> $GITHUB_OUTPUT
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "version=$(git describe --tags --always)" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute image tags
        id: meta
        run: |
          SHORT_SHA=$(echo "$GITHUB_SHA" )
          echo "  SHA tag: ${{ vars.DOCKERHUB_USERNAME }}/api-node:$SHORT_SHA"
          echo "  Alias tag: ${{ vars.DOCKERHUB_USERNAME }}/api-node:dev"
          echo "sha_tag=${{ vars.DOCKERHUB_USERNAME }}/api-node:$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "alias_tag=${{ vars.DOCKERHUB_USERNAME }}/api-node:dev" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-24.04
    needs: build-and-push
    if: needs.build-and-push.outputs.services != '[]'
    strategy:
      matrix:
        service: ${{ fromJson(needs.build-and-push.outputs.services) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate Docker tags
        id: tags
        run: |
          SERVICE_NAME=$(basename ${{ matrix.service }})
          VERSION="${{ needs.build-and-push.outputs.version }}"
          
          # Use git describe if no version provided
          if [[ -z "$VERSION" ]]; then
            VERSION=$(git describe --tags --always)
          fi
          
          IMAGE_TAG="${{ vars.DOCKERHUB_USERNAME }}/${SERVICE_NAME}:${VERSION}"
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT